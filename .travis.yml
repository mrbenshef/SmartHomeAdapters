language: generic

before_install:
  # disable services enabled by default
  - sudo /etc/init.d/mysql stop
  - sudo /etc/init.d/postgresql stop

jobs:
  include:
    # Compiling reports
    - stage: test
      script:
      - docker pull dxjoke/tectonic-docker
      - |
        for DIR in reports/*/; do
          echo "Compiling ${DIR}";
          docker run --mount src=${TRAVIS_BUILD_DIR}/${DIR},target=/usr/src/tex,type=bind dxjoke/tectonic-docker /bin/sh -c "tectonic document.tex"
        done
    # test info server
    - stage: test
      script: eval "$(gimme 1.11)" && cd ${TRAVIS_BUILD_DIR}/infoserver && make test
    # test client server
    - stage: test
      script: eval "$(gimme 1.11)" && cd ${TRAVIS_BUILD_DIR}/clientserver && make test
    # test user server
    - stage: test
      script: eval "$(gimme 1.11)" && cd ${TRAVIS_BUILD_DIR}/userserver && make test
    # test robot server
    - stage: test
      script: eval "$(gimme 1.11)" && cd ${TRAVIS_BUILD_DIR}/robotserver && make test
